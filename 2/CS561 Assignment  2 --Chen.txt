-- Name: Junjie Chen
-- CWID: 10476718

-- query 1:

WITH T1 AS
(
	SELECT CUST,PROD,MONTH,STATE,AVG(QUANT) AS CUST_AVG FROM SALES
	GROUP BY CUST,PROD,MONTH,STATE
),
T2 AS
(
	SELECT S1.CUST,S1.PROD,S1.MONTH,S1.STATE,AVG(S2.QUANT) AS OTHER_PROD_AVG
	FROM SALES AS S1,SALES AS S2
	WHERE S1.MONTH = S2.MONTH
	AND S1.STATE = S2.STATE
	AND S1.CUST = S2.CUST
	AND S1.PROD != S2.PROD
	GROUP BY S1.CUST,S1.PROD,S1.MONTH,S1.STATE
),
T3 AS
(
	SELECT S.CUST,S.PROD,S.MONTH,S.STATE,AVG(S1.QUANT) AS OTHER_MONTH_AVG
	FROM SALES AS S,SALES AS S1 
	WHERE S.MONTH != S1.MONTH
	AND S.STATE = S1.STATE
	AND S.CUST = S1.CUST
	AND S.PROD = S1.PROD
	GROUP BY S.CUST,S.PROD,S.MONTH,S.STATE
),
T4 AS
(
	SELECT S.CUST,S.PROD,S.MONTH,S.STATE,AVG(S1.QUANT) AS OTHER_STATE_AVG
	FROM SALES AS S,SALES AS S1 
	WHERE S.MONTH = S1.MONTH
	AND S.STATE != S1.STATE
	AND S.CUST = S1.CUST
	AND S.PROD = S1.PROD
	GROUP BY S.CUST,S.PROD,S.MONTH,S.STATE
)
SELECT CUST AS CUSTOMER,PROD AS PRODUCT,MONTH,STATE,
	CUST_AVG,OTHER_PROD_AVG,OTHER_MONTH_AVG,OTHER_STATE_AVG
FROM T1 NATURAL FULL JOIN T2 NATURAL FULL JOIN T3 NATURAL FULL JOIN T4

-- query 2:

WITH T1 AS
(
	SELECT CUST,PROD,STATE,MONTH/4+1 AS Q1,AVG(QUANT)
	FROM SALES
	GROUP BY CUST,PROD,STATE,Q1
),
T2 AS
(
	SELECT T1.CUST,T1.PROD,T1.STATE,T1.Q1,A1.AVG AS BEFORE_AVG
	FROM T1,T1 AS A1 
	WHERE T1.CUST=A1.CUST
	AND T1.PROD=A1.PROD
	AND T1.STATE=A1.STATE
	AND A1.Q1=T1.Q1-1
),
T3 AS
(
	SELECT T1.CUST,T1.PROD,T1.STATE,T1.Q1,A1.AVG AS AFTER_AVG
	FROM T1,T1 AS A1 
	WHERE T1.CUST=A1.CUST
	AND T1.PROD=A1.PROD
	AND T1.STATE=A1.STATE
	AND A1.Q1=T1.Q1+1
)
SELECT CUST AS CUSTOMER,PROD AS PRODUCT,STATE,Q1,BEFORE_AVG,AFTER_AVG
FROM T1 NATURAL FULL JOIN T2 NATURAL FULL JOIN T3

-- query 3:

WITH T1 AS
(
	select prod, quant,count(quant)
	from sales
	group by prod,quant
	order by prod, quant
),
T2 AS
(
	SELECT S.PROD,S.QUANT,COUNT(S1.QUANT) SMALLER
	FROM SALES AS S,SALES AS S1
	WHERE S.PROD = S1.PROD
	AND S.QUANT >= S1.QUANT
	GROUP BY S.PROD,S.QUANT
	ORDER BY S.PROD,S.QUANT
),
T3 AS
(
	SELECT S.PROD,S.QUANT,COUNT(S1.QUANT) BIGGER
	FROM SALES AS S,SALES AS S1
	WHERE S.PROD = S1.PROD
	AND S.QUANT <= S1.QUANT
	GROUP BY S.PROD,S.QUANT
	ORDER BY S.PROD,S.QUANT
),
T4 AS
(
	SELECT T2.PROD,T2.QUANT,SMALLER/COUNT AS SMALLER
	FROM T1,T2
	WHERE T1.PROD=T2.PROD
	AND T1.QUANT=T2.QUANT
),
T5 AS
(
	SELECT T3.PROD,T3.QUANT,BIGGER/COUNT AS BIGGER
	FROM T1,T3
	WHERE T1.PROD=T3.PROD
	AND T1.QUANT=T3.QUANT
),
T6 AS
(
	select prod,count(quant)/2 as mid
	from sales
	group by prod
	order by prod
)
SELECT T5.PROD AS PRODUCT,BIGGER AS "MEDIAN QUANT"
FROM T5,T6 
WHERE T5.PROD = T6.PROD
AND T5.BIGGER = T6.mid

-- query 4:

WITH T1 AS
(
	SELECT CUST,PROD,0.75*SUM(QUANT) AS TFP
	FROM SALES GROUP BY CUST,PROD
	ORDER BY CUST,PROD
),
T2 AS
(
	SELECT CUST,PROD,MONTH,SUM(QUANT) 
	FROM SALES GROUP BY CUST,PROD,MONTH
	ORDER BY CUST,PROD,MONTH
),
T3 AS
(
	SELECT T2.CUST,T2.PROD,T2.MONTH,SUM(T.SUM)
	FROM T2,T2 AS T
	WHERE T2.CUST=T.CUST
	AND T2.PROD=T.PROD
	AND T2.MONTH>=T.MONTH
	GROUP BY T2.CUST,T2.PROD,T2.MONTH
)
SELECT T1.CUST AS CUSTOMER,T1.PROD AS PRODUCT,MIN(MONTH) AS "75% PURCHASED BY MONTH"
FROM  T1 JOIN T3
ON T1.CUST=T3.CUST
AND T1.PROD=T3.PROD
AND T3.SUM>T1.TFP
GROUP BY T1.CUST,T1.PROD