WITH T1 AS
(
	SELECT CUST,PROD,MONTH,STATE,AVG(QUANT) AS CUST_AVG FROM SALES
	GROUP BY CUST,PROD,MONTH,STATE
),
T2 AS
(
	SELECT S1.CUST,S1.PROD,S1.MONTH,S1.STATE,AVG(S2.QUANT) AS OTHER_PROD_AVG
	FROM SALES AS S1,SALES AS S2
	WHERE S1.MONTH = S2.MONTH
	AND S1.STATE = S2.STATE
	AND S1.CUST = S2.CUST
	AND S1.PROD != S2.PROD
	GROUP BY S1.CUST,S1.PROD,S1.MONTH,S1.STATE
),
T3 AS
(
	SELECT S.CUST,S.PROD,S.MONTH,S.STATE,AVG(S1.QUANT) AS OTHER_MONTH_AVG
	FROM SALES AS S,SALES AS S1 
	WHERE S.MONTH != S1.MONTH
	AND S.STATE = S1.STATE
	AND S.CUST = S1.CUST
	AND S.PROD = S1.PROD
	GROUP BY S.CUST,S.PROD,S.MONTH,S.STATE
),
T4 AS
(
	SELECT S.CUST,S.PROD,S.MONTH,S.STATE,AVG(S1.QUANT) AS OTHER_STATE_AVG
	FROM SALES AS S,SALES AS S1 
	WHERE S.MONTH = S1.MONTH
	AND S.STATE != S1.STATE
	AND S.CUST = S1.CUST
	AND S.PROD = S1.PROD
	GROUP BY S.CUST,S.PROD,S.MONTH,S.STATE
)
SELECT CUST AS CUSTOMER,PROD AS PRODUCT,MONTH,STATE,
	CUST_AVG,OTHER_PROD_AVG,OTHER_MONTH_AVG,OTHER_STATE_AVG
FROM T1 NATURAL FULL JOIN T2 NATURAL FULL JOIN T3 NATURAL FULL JOIN T4