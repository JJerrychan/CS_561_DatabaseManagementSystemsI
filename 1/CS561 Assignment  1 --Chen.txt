-- Name: Junjie Chen
-- CWID: 10476718

-- query 1:

WITH T1 AS
(
	select
	cust as customer,
	min(quant) as min_q,
	max(quant) as max_q,
	round(avg(quant),0) as avg_q 
	from sales
	group by customer
),	
T2 AS
(
	SELECT 
	T1.CUSTOMER,T1.MIN_Q,
	S.PROD AS MIN_PROD,
	S.DATE AS MIN_DATE,
	S.STATE AS ST,
	T1.MAX_Q,T1.AVG_Q
	FROM T1,SALES AS S
	WHERE T1.CUSTOMER = S.CUST
	AND T1.MIN_Q = S.QUANT
)
SELECT
T2.CUSTOMER,T2.MIN_Q,T2.MIN_PROD,T2.MIN_DATE,T2.ST,T2.MAX_Q,
S.PROD AS MAX_PROD,
S.DATE AS MAX_DATE,
S.STATE AS ST,
T2.AVG_Q
FROM T2,SALES AS S
WHERE T2.CUSTOMER = S.CUST
AND T2.MAX_Q = S.QUANT

-- query 2:

WITH T1 AS
(
	SELECT
	CUST AS CUSTOMER,
	PROD AS PRODUCT,
	MAX(QUANT) AS OCT_MAX
	FROM SALES
	WHERE MONTH = 10
	AND YEAR > 2017
	GROUP BY CUST,PROD
),
T2 AS 
(
	SELECT
	T1.CUSTOMER,T1.PRODUCT,T1.OCT_MAX,
	S.DATE AS OCT_DATE
	FROM T1,SALES AS S
	WHERE T1.OCT_MAX = S.QUANT
	AND MONTH = 10
	AND YEAR > 2017
	AND T1.CUSTOMER = S.CUST
	AND T1.PRODUCT = S.PROD
),
T3 AS
(
	SELECT
	CUST AS CUSTOMER,
	PROD AS PRODUCT,
	MIN(QUANT) AS NOV_MIN
	FROM SALES
	WHERE MONTH = 11
	GROUP BY CUST,PROD
),
T4 AS 
(
	SELECT
	T3.CUSTOMER,T3.PRODUCT,T3.NOV_MIN,
	S.DATE AS NOV_DATE
	FROM T3,SALES AS S
	WHERE T3.NOV_MIN = S.QUANT
	AND MONTH = 11
	AND T3.CUSTOMER = S.CUST
	AND T3.PRODUCT = S.PROD
),
T5 AS
(
	SELECT
	CUST AS CUSTOMER,
	PROD AS PRODUCT,
	MIN(QUANT) AS DEC_MIN
	FROM SALES
	WHERE MONTH = 12
	GROUP BY CUST,PROD
),
T6 AS 
(
	SELECT
	T5.CUSTOMER,T5.PRODUCT,T5.DEC_MIN,
	S.DATE AS DEC_DATE
	FROM T5,SALES AS S
	WHERE T5.DEC_MIN = S.QUANT
	AND MONTH = 12
	AND T5.CUSTOMER = S.CUST
	AND T5.PRODUCT = S.PROD
),
T7 AS
(
	SELECT T2.CUSTOMER,T2.PRODUCT,T2.OCT_MAX,T2.OCT_DATE,T4.NOV_MIN,T4.NOV_DATE
	FROM T2 FULL JOIN T4 
	ON T2.CUSTOMER = T4.CUSTOMER
	AND T2.PRODUCT = T4.PRODUCT
)
SELECT 
	T7.CUSTOMER,T7.PRODUCT,T7.OCT_MAX,
	T7.OCT_DATE,T7.NOV_MIN,T7.NOV_DATE,
	T6.DEC_MIN,T6.DEC_DATE
FROM T7 JOIN T6
ON T7.CUSTOMER = T6.CUSTOMER
AND T7.PRODUCT = T6.PRODUCT


-- query 3:

WITH T1 AS
(
	SELECT MONTH,PROD,SUM(QUANT) 
	FROM SALES
	GROUP BY MONTH,PROD
),
T2 AS
(
	SELECT MONTH,MAX(SUM),MIN(SUM)
	FROM T1
	GROUP BY MONTH
),
T3 AS
(
	SELECT T2.MONTH,
		T1.PROD AS MOST_POPULAR_PROD,
		T2.MAX AS MOST_POP_TOTAL_Q,
		T2.MIN AS LEAST_POP_TOTAL_Q
	FROM T2,T1
	WHERE T2.MONTH = T1.MONTH
	AND T2.MAX = T1.SUM
)
SELECT T3.MONTH,
	T3.MOST_POPULAR_PROD,
	T3.MOST_POP_TOTAL_Q,
	T1.PROD AS LEAST_POPULAR_PROD,
	T3.LEAST_POP_TOTAL_Q
FROM T3,T1
WHERE T3.MONTH = T1.MONTH
AND T3.LEAST_POP_TOTAL_Q = T1.SUM


-- query 4:

WITH T1 AS
(
	SELECT DISTINCT PROD AS PRODUCT,MONTH,SUM(QUANT)FROM SALES GROUP BY PROD,MONTH
),
T2 AS
(
	SELECT PRODUCT,MAX(SUM),MIN(SUM) FROM T1 GROUP BY PRODUCT
),
T3 AS
(
	SELECT T2.PRODUCT,T1.MONTH AS MOST_FAV_MO,T2.MIN
	FROM T2,T1
	WHERE T2.PRODUCT = T1.PRODUCT
	AND T2.MAX = T1.SUM
)
SELECT
	T3.PRODUCT,
	T3.MOST_FAV_MO,
	T1.MONTH AS LEAST_FAV_MO
FROM T3,T1
WHERE T3.PRODUCT = T1.PRODUCT
AND T3.MIN = T1.SUM


-- query 5:

WITH CT AS
(
	SELECT PROD,CUST,ROUND(AVG(QUANT),0) AS CT_AVG
	FROM SALES WHERE 
	YEAR BETWEEN 2016 AND 2020
	AND STATE = 'CT'
	GROUP BY CUST,PROD
),
NY AS
(
	SELECT PROD,CUST,ROUND(AVG(QUANT),0) AS NY_AVG
	FROM SALES WHERE 
	YEAR BETWEEN 2016 AND 2020
	AND STATE = 'NY'
	GROUP BY CUST,PROD
),
NJ AS
(
	SELECT PROD,CUST,ROUND(AVG(QUANT),0) AS NJ_AVG
	FROM SALES WHERE 
	YEAR BETWEEN 2016 AND 2020
	AND STATE = 'NJ'
	GROUP BY CUST,PROD
),
PA AS
(
	SELECT PROD,CUST,ROUND(AVG(QUANT),0) AS PA_AVG
	FROM SALES WHERE 
	YEAR BETWEEN 2016 AND 2020
	AND STATE = 'PA'
	GROUP BY CUST,PROD
),
AVG AS
(
	SELECT PROD,CUST,ROUND(AVG(QUANT),0) AS AVERAGE
	FROM SALES WHERE 
	YEAR BETWEEN 2016 AND 2020
	GROUP BY CUST,PROD
),
TOTAL AS
(
	SELECT PROD,CUST,SUM(QUANT) AS TOTAL
	FROM SALES WHERE 
	YEAR BETWEEN 2016 AND 2020
	GROUP BY CUST,PROD
),
COUNT AS
(
	SELECT PROD,CUST,COUNT(QUANT) AS COUNT
	FROM SALES WHERE 
	YEAR BETWEEN 2016 AND 2020
	GROUP BY CUST,PROD
)
SELECT
	TOTAL.PROD AS PRODUCT,
	TOTAL.CUST AS CUSTOMER,
	CT.CT_AVG,NY.NY_AVG,NJ.NJ_AVG,PA.PA_AVG,
	AVG.AVERAGE,TOTAL.TOTAL,COUNT.COUNT
FROM (((((TOTAL JOIN CT ON TOTAL.PROD = CT.PROD AND TOTAL.CUST = CT.CUST)
	JOIN NY ON TOTAL.PROD = NY.PROD AND TOTAL.CUST = NY.CUST)
	JOIN NJ ON TOTAL.PROD = NJ.PROD AND TOTAL.CUST = NJ.CUST)
	JOIN PA ON TOTAL.PROD = PA.PROD AND TOTAL.CUST = PA.CUST)
	JOIN AVG ON TOTAL.PROD = AVG.PROD AND TOTAL.CUST = AVG.CUST)
	JOIN COUNT ON TOTAL.PROD = COUNT.PROD AND TOTAL.CUST = COUNT.CUST

-- end